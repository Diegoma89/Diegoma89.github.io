<!DOCTYPE html>
<html>
<script src="https://d3js.org/d3.v5.min.js"></script>
<style>

body {
      overflow: auto;
		  margin: 0;
		  font-size: 20px;
		  font-family: "Copperplate Gothic Light",serif;
		}
h1 {
  text-align: center;
  font-size: 30px;
  background-color: firebrick;
  color: goldenrod;
}
rect {stroke: black;}
path.fade{ display: none;}
.link line {stroke: black;}
.node circle {
  stroke: black;
  fill: White;
}
.node text {
  text-anchor: middle;
  font-size: 10px;}
.icon text {
  text-anchor: middle;
  font-size: 10px;
}

.imgborder
{
  fill: transparent;
  stroke: transparent;
  stroke-width: 3px;
  shape-rendering: crispEdges;
}

.imgborder:hover
{
  stroke: black;
}

.button:hover {
  background-color: grey;
}

.civlist {
  float: left;
  margin-left: 900px;
}

.active {
  background-color: grey;
  color: white;
  border: 2px solid black;
  cursor: not-allowed;
  pointer-events: none;
}

.inactive {
  background-color: white;
  color: black;
  border: 1px solid black;
}

.btnstory {
  cursor: not-allowed;
  pointer-events: none;
}

.init {
  margin-left: 10px;
}

.slides {
  border-radius: 4px;
  padding: 2px 10px;
  text-anchor: center;
  font-size: 16px;
  float: left;
}

.storytext
{
   position: absolute;
   text-anchor: middle;
   width: 100px;
   font-size: 20px;
}

div.tooltip {
    position: absolute;
    text-align: center;
    width: 60px;
    height: 20px;
    padding: 10px;
    font: 12px;
    background: lightgray;
    border-radius: 5px;
    pointer-events: none;
}

#civtextdiv {
  position: absolute;
  opacity: 1;
  text-align: left;
   word-wrap: break-word;
   width: 850px;
   font-size: 18px;
}

#civtextdivteam {
  position: absolute;
  opacity: 1;
   word-wrap: break-word;

}

</style>
<body onload="init()">

<h1 id="slideTitle"></h1>

<div id="btngroup">
  <button id="S1" class="button init slides active" onclick="Press1()">1</button>
  <button id="S2" class="button slides inactive" onclick="Press2()">2</button>
  <button id="S3" class="button slides inactive" onclick="Press3()">3</button>
</div>

<p><br></p>
<div id="civtextdiv"></div>
<div id="civtextdivteam"></div>

<script>

function init(){
  Slide1();
}

var civtextdiv = d3.select("#civtextdiv");
var civtextdivteam = d3.select("#civtextdivteam");
var civselection = "Aztecs";
var civlist;
var counter = 0;
var story = 1;
var color = ["#7f007f","#ffff54","#808000","#9acd32","#7b68ee","#006400","#b0c4de","#00ced1","#ff4500","#008080","#ff69b4","#fffff0","#3cb371","#ff00ff","#4682b4","#d2b48c","#0000ff","#ffc0cb",
             "#fa8072","#32cd32","#8b0000","#dc143c","#dda0dd","#9400d3","#696969","#cd853f","#ffa500","#f0e68c","#b03060","#7fffd4","#98fb98","#1e90ff","#483d8b","#00ff00","#000080"];
var txtcolor = ["white","black","white","black","white","white","black","black","white","white","black","black","black","white","white","black","white","black",
                "black","black","white","white","black","white","white","black","black","black","white","black","black","white","white","black","white"];

var storytextarray = ["This dataset contains 3000+ team", "game matches in AOE2: DE.", "", "Each game can host up to 8 players", "in teams of at least 2"];


function Press1() {

     d3.selectAll("svg").remove();
     var activebtn = btngroup.getElementsByClassName("active");
     activebtn[0].className = activebtn[0].className.replace("active", "inactive");
     S1.className = S1.className.replace("inactive", "active");
     civtextdivteam.html("");

Slide1();
};

function Press2() {

  var activebtn = btngroup.getElementsByClassName("active");
  activebtn[0].className = activebtn[0].className.replace("active", "inactive");
  S2.className = S2.className.replace("inactive", "active");
  d3.selectAll("svg").remove();
  slide2();
}


function Press3() {
  var activebtn = btngroup.getElementsByClassName("active");
  activebtn[0].className = activebtn[0].className.replace(" active", " inactive");
  S3.className = S3.className.replace("inactive", "active");
  d3.selectAll("svg").remove();
  civtextdivteam.html("");
  slide3();
}

function rotate(angle){
    if(angle > Math.PI) {
        return "rotate(180)"; }
    else { return ""; }
    };



async function Slide1() {

document.getElementById("slideTitle").innerHTML = "Age of Empires 2: Definitive Edition - Winrate by Civilization in Team Games";

  const winrateciv = await d3.csv("https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/winrate_civ.csv");
  const civdetails = await d3.csv("https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/CivTexts/civdetails.csv");

  //var color = d3.scaleOrdinal(d3.schemeTableau10);

  civlist = winrateciv.map(function(d) {return d.civ});
  winrates = winrateciv.map(function(d) {return d.winrate});
  winrateMean = d3.mean(winrateciv.map(function(d){return d.winrate}));


  function updatepie(d, i){


      var barselection = d3.event.srcElement.__data__;
      var barelement = d3.event.srcElement;

      if(story ==1){
        barselection = winrateciv.filter(function(d) {return d.civ == civselection})[0];
        barelement = document.getElementById(civselection);
      }
       svg.selectAll("image").remove();
       barchartbars.selectAll("rect").style("stroke-width", 0.5);
       d3.select(barelement).style("stroke-width", 3);

       groupspie.selectAll("path")
         .data(pie([barselection.winrate, 1-barselection.winrate]))
           .attr("d", arc)
           .attr("fill", function(d,i) {if(i==0) { return color[5]} else {return color[21]};})
           .attr("stroke", "black")
           .attr("stroke-width", 0.5);


       groupspie.append("image")
           .attr("href", "https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/Icons/CivIcon-" + barselection.civ + ".png")
           .attr("x", -50)
           .attr("y", -50)
           .attr("height", "100px")
           .attr("width", "100px");


           groupspie.selectAll("text").remove();

           groupspie.append("text")
               .each(function(d){ return d.angle = (d.startAngle + d.endAngle) /2; })
               .attr("class", "text")
               .style("pointer-events","none")
               .attr("text-anchor", function(d) { if(d.angle > Math.PI) { return "end"; } else { return "start"; }})
               .attr("transform", function(d,i){
                   return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
                          "translate(" + (outrad + 10) + ")" +
                           (rotate(d.angle));

               })
               .text(function(d,i) {if(i==0) { return (barselection.winrate*100).toFixed(1)+"%"} else {return ((1-barselection.winrate)*100).toFixed(1)+"%"};})
               .style("font-size","15px")
               .style("font-weight","bold");


var civdet = civdetails.filter(function(d) {return d.Civ.includes(barselection.civ)});

var focus = civdet.map(function(d) {return d.Focus});
var CivUU = civdet.map(function(d) {return d.UU});
var TeamBonus = civdet.map(function(d) {return d.TB});


civtextdiv.html("<b>"+barselection.civ+" "+"Civilization Details</b><br><br>"+"<b>Focus: </b>"+focus+"<br><br>"+"<b>Unique Unit: </b>"+CivUU+"<br><br>"+"<b>Team Bonus: </b>"+TeamBonus);

  }


  var screenw = (1920-10);
  var width = 1500;
  var heightsvg = 700;
  var smargin = (screenw-width)/2;
  var tmargin = 50;
  var widthpie = 300;
  var height = heightsvg - widthpie;
  var heightbar = height + (tmargin*2);


  var svg = d3.select("body").append("svg")
      .attr("id",  "winratesciv")
      .attr("width",  width+(smargin*2))
      .attr("height", heightsvg+(tmargin*2));



  x = d3.scaleBand().domain(civlist).range([0,width]).padding(0.2);;
  y = d3.scaleLinear().domain([0,1]).range([height,0]);

var barchartbars = svg.append("g")
      .attr("transform", "translate("+smargin+","+tmargin+")");

    barchartbars.selectAll("rect")
    .data(winrateciv)
    .enter()
    .append("rect")
      .attr("class",function(d) {return d.civ;})
      .attr("id",function(d) {return d.civ;})
      .attr("x",function(d) {return x(d.civ);})
      .attr("y",function(d) {return y(0);})
      .attr("width",x.bandwidth())
      .attr("height",0)
      .style("fill", function(d, i) {return color[i];})
      .style("stroke-width", 0.5);

var annotations = svg.append("g")
                      .attr("transform", "translate("+smargin+","+tmargin+")");


  annotations.selectAll("line")
    .data([winrateMean,0.5])
    .enter()
      .append("line")
      .transition()
      .duration(1000)
      .attr("x1", 0)
      .attr("y1", function(d){return y(d);})
      .attr("x2", width)
      .attr("y2", function(d){return y(d);})
      .attr("stroke", function(d, i){if(i==0){return "red";}else{return "black"}})
      .attr("stroke-width", 2)
      .style("stroke-dasharray","5,5");

var barlegend = svg.append("g")
                   .attr("transform", "translate("+(smargin+width)+","+tmargin+")");

barlegend.selectAll("line")
         .data(["Average", "50%: Positive winrate"])
         .enter()
         .append("line")
            .attr("x1", 0)
            .attr("y1", function(d, i){return 20*i;})
            .attr("x2", 30)
            .attr("y2", function(d, i){return 20*i;})
            .attr("stroke", function(d, i){if(i==0){return "red";}else{return "black"}})
            .attr("stroke-width", 2)
            .style("stroke-dasharray","5,5");

barlegend.selectAll("text")
         .data(["Average", "50%: Positive winrate"])
         .enter()
         .append("text")
            .attr("x",40)
            .attr("y", function(d, i){return 5+(20*i);})
            .text(function(d){return d;})
            .style("font-size", "12px")
            .style("pointer-events", "none")
            .style("font-weight", "bold");


  svg.append("g")
      .attr("transform", "translate("+smargin+","+tmargin+")")
      .call(d3.axisLeft(y).tickFormat(d3.format("~%")));

  svg.append("g")
      .attr("transform", "translate("+smargin+","+(height+tmargin)+")")
      .call(d3.axisBottom(x))
      .selectAll("text")
      .attr("y", 0)
      .attr("x", 9)
      .attr("dy", ".35em")
      .attr("transform", "rotate(90)")
      .style("text-anchor", "start");



  barchartbars.selectAll("rect")
    .transition()
    .duration(1000)
    .attr("y", function(d) {return y(d.winrate);})
    .attr("height", function(d,i) {return y(1-Number(d.winrate));})

//Pie chart


var inrad = 50;
var outrad = 100;
var colorinit = ["grey","darkgrey"];
//var color = ["green","red"];
var pie = d3.pie().sort(null);
var arc = d3.arc().innerRadius(inrad).outerRadius(outrad);



var groupspie = svg.append("g")
    .attr("transform", "translate(550,"+(heightbar+(tmargin)+outrad)+")")
    .selectAll("g")
    .data(pie([0.5, 0.5]))
    .enter()
    .append("g");


      groupspie.selectAll("path")
        .data(pie([0.5, 0.5]))
        .enter()
        .append("path")
          .attr("d", arc)
          .attr("fill", function(d,i) {return colorinit[i];});

 groupspie.append("text")
    .each(function(d){ return d.angle = (d.startAngle + d.endAngle) /2; })
    .attr("class", "text")
    .style("pointer-events","none")
    .attr("text-anchor", function(d) { if(d.angle > Math.PI) { return "end"; } else { return "start"; }})
    .attr("transform", function(d,i){
        return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
               "translate(" + (outrad + 10) + ")" +
                (rotate(d.angle));

    })
    .text(function(d,i) {if(i==0) { return "%"} else {return "%"};})
    .style("font-family","sans-serif")
    .style("font-size","15px");


barchartbars.on("mouseover", updatepie);


groupspie.append("image")
    .attr("href", "https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/CivIcon-q.png")
    .attr("x", -50)
    .attr("y", -50)
    .attr("height", "100px")
    .attr("width", "100px");

svg.append("rect")
.attr("x",10)
.attr("y",1)
.attr("width", 1899)
.attr("height",799)
.style("fill", "none")
.style("stroke-width", 1.5);

svg.append("rect")
.attr("x",10)
.attr("y",525)
.attr("width", 1899)
.attr("height",274)
.style("fill", "none")
.style("stroke-width", 1.5);


    civtextdiv.style("left","850px").style("top", (heightbar+(tmargin)+outrad+50)+"px").html("<b>Civilization Details</b><br><br>"+"<b>Focus: ?</b>"+"<br><br>"+"<b>Unique Unit: ?</b>"+"<br><br>"+"<b>Team Bonus: ?</b>");

if(story == 1){

  var slidebtns = document.getElementsByClassName("button");
  for(i=0; i<document.getElementsByClassName("button").length; i++){

      slidebtns[i].className += " btnstory";
  }

  var pageblock = svg.append("rect");

  pageblock.attr("x",10)
  .attr("y",1)
  .attr("width", 1899)
  .attr("height",798)
  .style("fill", "white")
  .style("opacity", 0.6)
  .style("stroke-width", 1.5);

var storybox = svg.append("g")
                  .attr("transform", "translate(800,20)");

  storybox.append("rect")
  .attr("rx", 20)
  .attr("ry", 20)
  .attr("width", 400)
  .attr("height",200)
  .style("fill", "lightgray")
  .style("opacity", 0)
  .style("stroke-width", 1.5);


  storybox.selectAll("text")
  .data(storytextarray)
  .enter()
    .append("text")
    .style("opacity", 0)
    .attr("class", "storytext")
    .attr("x", "200");



  var storyboxbtn = svg.append("g")
  .attr("transform", "translate(950,170)");

  storyboxbtn.append("rect")
  .attr("rx", 10)
  .attr("ry", 10)
  .attr("width", 100)
  .attr("height",40)
  .style("fill", "white")
  .style("opacity", 0)
  .style("stroke-width", 1);

  storyboxbtn.append("text")
  .style("font-size", "16px")
  .style("pointer-events", "none")
  .style("opacity", 0)
  .attr("x",8)
  .attr("y",25);

  storyboxbtn.on("mouseup", storyshow);


  updatestorytext();


}; //Story mode

function updatestorytext(){

  storybox.selectAll("text")
             .style("opacity", 0);


  storybox.selectAll("rect")
          .transition()
          .duration(1000)
          .style("opacity", 0.8);

  storybox.selectAll("text")
          .data(storytextarray)
          .text(function(d){return d})
          .attr("y", function(d, i) {return 30+(i*25)} )
          .transition()
          .duration(1000)
          .style("opacity", 0.8);

  storyboxbtn.selectAll("rect")
             .transition()
             .duration(1000)
             .style("opacity", 0.8);

  storyboxbtn.selectAll("text")
          .text("Continue")
          .transition()
          .duration(1000)
          .style("opacity", 0.8);

}


function storyshow(){

  if(counter == 0){
    pageblock.style("opacity", 0);
  civselection = "Mayans";
  updatepie();
  storytextarray = ["Let's have a look at Mayans.", "", "They focus on archers and their", "winrate is above average at 53.1%", ""];
  updatestorytext();

var annotRL = svg.append("g");

  annotRL.append("rect")
     .attr("x",655)
     .attr("y",630)
     .attr("width", 60)
     .attr("height",30)
     .style("fill", "none")
     .style("stroke-width", 2)
     .style("opacity", 0);


annotRL.append("line")
       .attr("x1", 800)
       .attr("y1", 200)
       .attr("x2", 705)
       .attr("y2", 630)
       .attr("stroke", "black")
       .attr("stroke-width", 2)
       .style("opacity", 0);

 annotRL.selectAll("rect")
          .transition()
          .duration(1000)
          .style("opacity", 1);

annotRL.selectAll("line")
         .transition()
         .duration(1000)
         .style("opacity", 1);



}
if (counter == 1) {
  storytextarray = ["They pair up with Britons a lot.", "Archer strategies are amplified", "due Britons team bonus.", "Indians and Franks follow closely", "How do paired winrates look?"];

    Press2();
}

counter++;
console.log(counter);
};


};


async function slide2(){

document.getElementById("slideTitle").innerHTML = "Age of Empires 2: Definitive Edition - Civilization Pairing in Team Games";
        const pairsMatrix = await d3.csv("https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/PairsMatrixComplete.csv");
        const civdetails = await d3.csv("https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/CivTexts/civdetails.csv");


        var margin      = {top: 10, right: 10, bottom: 10, left: 110};
        var width       = 900 - margin.left - margin.right;
        var widthsvg       = 1910;
        var height      = 800 - margin.top  - margin.bottom;
        var innerRadius = 300;
        var outerRadius = innerRadius * 1.05;

        var svgf = d3.select("body").append("svg")
            .attr("id",  "chordchart")
            .attr("width",  widthsvg)
            .attr("height", height + margin.top  + margin.bottom);

        var svg = svgf.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .append("g")
            .attr("class", "chordgraph")
            .attr("transform", "translate(" + width/2 + "," + height/2 + ")");


        var firstColumn = "Civ1";

        //store column names
        var fc = [],
            mat_size = pairsMatrix.length,
            matrix  = [];

        for(var i=0; i < mat_size; i++){
            matrix.push(new Array(mat_size+1).join("0").split("").map(parseFloat));
        }

        for(var i=0; i < mat_size; i++){

            var j = 0;

            for(var pairm in pairsMatrix[i]){

                if(pairm != firstColumn){
                    fc.push(pairm);
                    matrix[i][j] = +pairsMatrix[i][pairm];
                    matrix[j][i] = +pairsMatrix[i][pairm];
                    j++;
                }
            }
        }

        var fo = fc.slice(0,mat_size);


        //d3 chord generator
        var chord = d3.chord()
            .padAngle(0.01)
            .sortSubgroups(d3.descending);

        //apply the matrix
        var chords = chord(matrix);

        //each ribbon generator
        var ribbon = d3.ribbon()
            .radius(innerRadius);

        //outer rim arc
        var arc = d3.arc()
            .innerRadius(innerRadius)
            .outerRadius(innerRadius + 20);

        //add each of the groupings for outer rim arcs
        var group = svg.append("g")
            .selectAll("g")
            .data(chords.groups)
            .enter()
            .append("g");


        //add each outer rim arc path
        group.append("path")
            .attr("fill", function(d){ return color[d.index]; })
            .attr("d", arc)
            .style("cursor", "pointer")
            .on("mouseover", function (d, i){
              civselection = civlist[i];
                var counter = 0;
                if(counter==0){
                  updatetext(i);
                }
                counter++;
                ribbons.classed("fade", function(d, j){

                    return d.source.index != i && d.target.index != i;
                });
            });

        //add each ribbon
        var ribbons = svg.append("g")
          .attr("fill-opacity", .5)
          .selectAll("path")
          .data(chords)
          .enter()
          .append("path")
          .attr("d", ribbon)
          .attr("fill", function(d){ return color[d.source.index]; })
          .attr("stroke", "black")
          .style("stroke","Black")
          .style("stroke-width",".25px");


        //add the text labels
        group.append("text")
          .each(function(d){ return d.angle = (d.startAngle + d.endAngle) /2; })
          .attr("class", "text")
          .style("pointer-events","none")
          .attr("text-anchor", function(d) { if(d.angle > Math.PI) { return "end"; } else { return "start"; }})
          .attr("transform", function(d,i){
              return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
                     "translate(" + (outerRadius + 10) + ")" +
                     (rotate(d.angle));

          })
          .text(function(d,i){
              //set the text content
              return fc[i];
          })
          .style("font-family","sans-serif")
          .style("font-size","15px");



            window.addEventListener("mouseup", (e) => {
              if(e.target.id === "chordchart"){
                ribbons.classed("fade", false);
                civtextdivteam.html("<b>Civilization Details</b><br><br>"
                                                                               +"<b>Focus: ?</b>"+"<br><br>"+"<b>Unique Unit: ?</b>"+"<br><br>"+"<b>Team Bonus: ?</b>");

                civtextdiv.html("<b>Most likely paired</b>"
                                +"<br>?"
                                +"<br>?"
                                +"<br>?"
                                +"<br><br><br><b>Least likely paired</b>"
                                +"<br>?"
                                +"<br>?"
                                +"<br>?");
                svgf.select("image")
                    .attr("href", "https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/CivIcon-q.png");
              };
            })

civtextdivteam.style("left","1000px")
.style("text-align", "center")
.style("width", "920px")
.style("font-size", "18px")
.style("top", "150px").html("<b>Civilization Details</b><br><br>"
                            +"<b>Focus: ?</b>"+"<br><br>"+"<b>Unique Unit: ?</b>"+"<br><br>"+"<b>Team Bonus: ?</b>");


svgf.append("image")
    .attr("href", "https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/CivIcon-q.png")
    .attr("x", 1350)
    .attr("y", 220)
    .attr("height", "200px")
    .attr("width", "200px");

civtextdiv.style("left","1050px")
          .style("top", "580px").html("<b>Most likely paired</b>"
                                      +"<br>?"
                                      +"<br>?"
                                      +"<br>?"
                                      +"<br><br><br><b>Least likely paired</b>"
                                      +"<br>?"
                                      +"<br>?"
                                      +"<br>?");


svgf.append("rect")
.attr("x",10)
.attr("y",1)
.attr("width", 990)
.attr("height",798)
.style("fill", "none")
.style("stroke-width", 1.5);

svgf.append("rect")
.attr("x",1000)
.attr("y",1)
.attr("width", 909)
.attr("height",450)
.style("fill", "none")
.style("stroke-width", 1.5);


svgf.append("rect")
.attr("x",1000)
.attr("y",451)
.attr("width", 909)
.attr("height",348)
.style("fill", "none")
.style("stroke-width", 1.5);


function updatetext(i){

var selectwithindx = [];
for (var j=0; j<matrix[i].length; j++) {
  selectwithindx.push({"matches": matrix[i][j], "index": fc[j], "TeamBonus": civdetails.filter(function(d, i) { return i==j }).map(function(d) { return d.TB }),
  "Focus": civdetails.filter(function(d, i) { return i==j }).map(function(d) { return d.Focus })});
 };
 selectwithindx = selectwithindx.sort(function(a, b){return b.matches -a.matches;});
console.log(selectwithindx);

var civdet = civdetails.filter(function(d) {return d.Civ.includes(fc[i])});
var focus = civdet.map(function(d) {return d.Focus});
var CivUU = civdet.map(function(d) {return d.UU});
var TeamBonus = civdet.map(function(d) {return d.TB});

civtextdivteam.html("<b>"+fc[i]+" Civilization Details</b><br><br>"
                    +"<b>Focus: " +focus+ "</b>"+"<br><br>"+"<b>Unique Unit: " +CivUU+ "</b>"+"<br><br>"+"<b>Team Bonus: " +TeamBonus+ "</b>");

svgf.select("image")
    .attr("href", "https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/Icons/CivIcon-" + fc[i] + ".png");

  civtextdiv.html("<b>Most likely paired</b>"
                  +"<br><b>"+selectwithindx.filter(function(d, i) { if(i==0) { return d } }).map(function(d, i) { return d.index })+"</b> with "
                  +selectwithindx.filter(function(d, i) { if(i==0) { return d } }).map(function(d, i) { return d.matches }) + " matches"
                  +" - Focus: "+selectwithindx.filter(function(d, i) { return i==0 } ).map(function(d, i) { return d.Focus })
                  +" - Team Bonus: "+selectwithindx.filter(function(d, i) { return i==0 } ).map(function(d, i) { return d.TeamBonus })
                  +"<br><b>"+selectwithindx.filter(function(d, i) { if(i==1) { return d } }).map(function(d, i) { return d.index })+"</b> with "
                  +selectwithindx.filter(function(d, i) { if(i==1) { return d } }).map(function(d, i) { return d.matches }) + " matches"
                  +" - Focus: "+selectwithindx.filter(function(d, i) { return i==1 } ).map(function(d, i) { return d.Focus })
                  +" - Team Bonus: "+selectwithindx.filter(function(d, i) { return i==1 } ).map(function(d, i) { return d.TeamBonus })
                  +"<br><b>"+selectwithindx.filter(function(d, i) { if(i==2) { return d } }).map(function(d, i) { return d.index })+"</b> with "
                  +selectwithindx.filter(function(d, i) { if(i==2) { return d } }).map(function(d, i) { return d.matches }) + " matches"
                  +" - Focus: "+selectwithindx.filter(function(d, i) { return i==2 } ).map(function(d, i) { return d.Focus })
                  +" - Team Bonus: "+selectwithindx.filter(function(d, i) { return i==2 } ).map(function(d, i) { return d.TeamBonus })
                  +"<br><br><br><b>Least likely paired</b>"
                  +"<br><b>"+selectwithindx.filter(function(d, i) { if(i==34) { return d } }).map(function(d, i) { return d.index })+"</b> with "
                  +selectwithindx.filter(function(d, i) { if(i==34) { return d } }).map(function(d, i) { return d.matches }) + " matches"
                  +" - Focus: "+selectwithindx.filter(function(d, i) { return i==34 } ).map(function(d, i) { return d.Focus })
                  +" - Team Bonus: "+selectwithindx.filter(function(d, i) { return i==34 } ).map(function(d, i) { return d.TeamBonus })
                  +"<br><b>"+selectwithindx.filter(function(d, i) { if(i==33) { return d } }).map(function(d, i) { return d.index })+"</b> with "
                  +selectwithindx.filter(function(d, i) { if(i==33) { return d } }).map(function(d, i) { return d.matches }) + " matches"
                  +" - Focus: "+selectwithindx.filter(function(d, i) { return i==33 } ).map(function(d, i) { return d.Focus })
                  +" - Team Bonus: "+selectwithindx.filter(function(d, i) { return i==33 } ).map(function(d, i) { return d.TeamBonus })
                  +"<br><b>"+selectwithindx.filter(function(d, i) { if(i==32) { return d } }).map(function(d, i) { return d.index })+"</b> with "
                  +selectwithindx.filter(function(d, i) { if(i==32) { return d } }).map(function(d, i) { return d.matches }) + " matches"
                  +" - Focus: "+selectwithindx.filter(function(d, i) { return i==32 } ).map(function(d, i) { return d.Focus })
                  +" - Team Bonus: "+selectwithindx.filter(function(d, i) { return i==32 } ).map(function(d, i) { return d.TeamBonus }));

};


if(story == 1){


ribbons.classed("fade", function(d){ return d.source.index != 23 && d.target.index != 23;});
updatetext(23);


  svgf.append("rect")
  .attr("x",10)
  .attr("y",1)
  .attr("width", 1899)
  .attr("height",798)
  .style("fill", "white")
  .style("opacity", 0)
  .style("stroke-width", 1.5);

var storybox = svgf.append("g")
.attr("transform", "translate(800,20)");

  storybox.append("rect")
  .attr("rx", 20)
  .attr("ry", 20)
  .attr("width", 400)
  .attr("height",200)
  .style("fill", "lightgray")
  .style("opacity", 0.8)
  .style("stroke-width", 1.5);


  storybox.selectAll("text")
  .data(storytextarray)
  .enter()
    .append("text")
    .attr("class", "storytext");

    updatestorytext();


  var storyboxbtn = svgf.append("g")
  .attr("transform", "translate(950,170)");

  storyboxbtn.append("rect")
  .attr("rx", 10)
  .attr("ry", 10)
  .attr("width", 100)
  .attr("height",40)
  .style("fill", "white")
  .style("opacity", 0.8)
  .style("stroke-width", 1);

  storyboxbtn.append("text")
  .text("Continue")
  .style("font-size", "16px")
  .style("pointer-events", "none")
  .attr("x",8)
  .attr("y",25);

  storyboxbtn.on("mouseup", storyshow);


  svgf.append("rect")
     .attr("x",1350)
     .attr("y",70)
     .attr("width", 210)
     .attr("height",30)
     .style("fill", "yellow")
     .style("opacity", 0)
     .style("stroke-width", 2)
     .transition()
     .duration(2000)
     .style("opacity", 0.5);





     svgf.append("rect")
       .attr("x", 1030)
       .attr("y", 460)
       .attr("width", 870)
       .attr("height",140)
       .style("fill", "yellow")
       .style("opacity", 0)
       .transition()
       .duration(2000)
       .style("opacity", 0.5);



}; //Story mode

function updatestorytext(){

  storybox.selectAll("text")
             .style("opacity", 0);

  storybox.selectAll("text")
  .data(storytextarray)
    .text(function(d){return d})
    .attr("x", "200")
    .attr("y", function(d, i) {return 30+(i*25)} )
    .transition()
    .duration(1000)
    .style("opacity", 1);

}


function storyshow(){

  storytextarray = ["They do very well together!", "", "Teaming up increased mayans", "individual winrate of 53.1% to ", "61.3% when paired with Britons."];
  Press3();
};

};


async function slide3(){

document.getElementById("slideTitle").innerHTML = "Age of Empires 2: Definitive Edition - Civilization Pairing Winrate in Team Games";

const winrateciv = await d3.csv("https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/winrate_civ.csv");
 const data = await d3.csv("https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/data_matches_formatted_reduced.csv");
 const civ1WD = data.filter(function(d) {return d.teamcivs.includes(civselection)});
 const civdetails = await d3.csv("https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/CivTexts/civdetails.csv");


var  civlist = winrateciv.map(function(d) {return d.civ});
var  winrates = winrateciv.map(function(d) {return d.winrate});

var divtp = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);



  var i;
  var PairWins = [];
  var PairMatches = [];
  var PairWinrates = [];
  var nodes = [{"value": (" "+civselection+" ")}];
  var links = [];

  for (i = 0; i < civlist.length; i++) {

    if (civlist[i] == civselection) {
      var civ2WD = civ1WD.filter(function(d) { if(d.teamcivs.indexOf(civlist[i]) != d.teamcivs.lastIndexOf(civlist[i])) {return d.teamcivs} });
      if(civ2WD.length>0){
      nodes.push({"value": civlist[i]});
      links.push({"source":  (" "+civselection+" "), "target":  civlist[i], "winrate": ((d3.sum(civ2WD, function(d) { return d.won }))/civ2WD.length)});
      };
    }
    else {
      var civ2WD = civ1WD.filter(function(d) {return d.teamcivs.includes(civlist[i])});
      if(civ2WD.length>0){
      nodes.push({"value": civlist[i]});
      links.push({"source":  (" "+civselection+" "), "target":  civlist[i], "winrate": ((d3.sum(civ2WD, function(d) { return d.won }))/civ2WD.length)});
      };
    };

    var PairWin = d3.sum(civ2WD, function(d) { return d.won });
    PairWins.push(PairWin);
    PairMatches.push(civ2WD.length);
    PairWinrates.push({"civpair": civlist[i], "winrate": PairWin/civ2WD.length, "matches": civ2WD.length, "TeamBonus": civdetails.filter(function(d, k) { return k==i }).map(function(d) { return d.TB }),
                       "Focus": civdetails.filter(function(d, k) { return k==i }).map(function(d) { return d.Focus })})
  };


var width = 1000;
var height = 800;
var widthsvg = 1910;
var radius = 35;
var margin = 10;
var svg = d3.select("body").append("svg")
    .attr("id",  "nodechart")
    .attr("width",  widthsvg)
    .attr("height", height);


var simulation = d3.forceSimulation()
.force("link", d3.forceLink().distance(function(d) { return 400-(d.winrate*400)})
    .id(function(d) { return d.value;}))
.force("charge", d3.forceManyBody().strength(-1000))
.force("center", d3.forceCenter(width / 2, height / 2));



simulation.nodes(nodes);


simulation.force("link").links(links);


var linksel = svg.append("g")
.attr("class", "link")
.selectAll("line").data(links).enter().append("line")

var nodesel = svg.selectAll(".node")
.data(nodes)
.enter().append("g")
.attr("class", "node")
.call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended));

console.log(nodes);
nodesel.append("circle")
.attr("r",radius)
.attr("id",function(d, i) {return d.value})
.style("fill",function(d, i) {if(i==0){return "#000000"} else{ return color[i-1] } } )
.on("mouseover", function(d) {
              if( d3.event.srcElement.id != (" " + civselection + " ") ){
            divtp.style("opacity", .8);
            divtp.html( (PairWinrates.filter(function(d) { return d.civpair == d3.event.srcElement.id }).map(function(d) { return d.winrate })*100).toFixed(1)+"%" )
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
            }})
        .on("mouseout", function(d) {  divtp.style("opacity", 0);});

nodesel.append("text")
.attr("transform","translate(0,4)")
.text(function (d) { return d.value; })
.style("fill", function (d, i) { if(i==0){return "white"; } else {return txtcolor[i-1]}})
.style("pointer-events","none");

// replace "tick" with "end" for static layout
simulation.on("tick", ticked);

function ticked() {


  nodesel.attr("cx", function(d) { return d.x = Math.max(radius + margin, Math.min(width - radius - margin, d.x)); })
        .attr("cy", function(d) { return d.y = Math.max(radius + margin, Math.min(height - radius - margin, d.y)); });

        linksel.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

            nodesel.attr("transform", function(d) {
              return "translate(" + d.x + "," + d.y + ")";
            });
}

function dragstarted(d) {
if (!d3.event.active) simulation.alphaTarget(0.3).restart();
d.fx = d.x;
d.fy = d.y;
}
function dragged(d) {
d.fx = d3.event.x;
d.fy = d3.event.y;
}
function dragended(d) {
if (!d3.event.active) simulation.alphaTarget(0);
d.fx = null;
d.fy = null;
}

PairWinrates = PairWinrates.sort(function(a, b){return b.winrate -a.winrate;});
console.log(PairWinrates);
civtextdiv.style("left","1050px").style("top", "580px").html("<b>Most likely pair to win</b>"
                                                            +"<br><b>"+PairWinrates.filter(function(d, i) { if(i==0) { return d } }).map(function(d, i) { return d.civpair })
                                                            +"</b> - Winrate: "+PairWinrates.filter(function(d, i) { if(i==0) { return d } }).map(function(d, i) { return (d.winrate*100).toFixed(1); })+"%"
                                                            +" on "+PairWinrates.filter(function(d, i) { if(i==0) { return d } }).map(function(d, i) { return d.matches })+" matches"
                                                            +" - Team Bonus: "+PairWinrates.filter(function(d, i) { return i==0 } ).map(function(d, i) { return d.TeamBonus })
                                                            +" - Focus: "+PairWinrates.filter(function(d, i) { return i==0 } ).map(function(d, i) { return d.Focus })
                                                            +"<br><b>"+PairWinrates.filter(function(d, i) { if(i==1) { return d } }).map(function(d, i) { return d.civpair })
                                                            +"</b> - Winrate: "+PairWinrates.filter(function(d, i) { if(i==1) { return d } }).map(function(d, i) { return (d.winrate*100).toFixed(1); })+"%"
                                                            +" on "+PairWinrates.filter(function(d, i) { if(i==1) { return d } }).map(function(d, i) { return d.matches })+" matches"
                                                            +" - Team Bonus: "+PairWinrates.filter(function(d, i) { return i==1 } ).map(function(d, i) { return d.TeamBonus })
                                                            +" - Focus: "+PairWinrates.filter(function(d, i) { return i==1 } ).map(function(d, i) { return d.Focus })
                                                            +"<br><b>"+PairWinrates.filter(function(d, i) { if(i==2) { return d } }).map(function(d, i) { return d.civpair })
                                                            +"</b> - Winrate: "+PairWinrates.filter(function(d, i) { if(i==2) { return d } }).map(function(d, i) { return (d.winrate*100).toFixed(1); })+"%"
                                                            +" on "+PairWinrates.filter(function(d, i) { if(i==2) { return d } }).map(function(d, i) { return d.matches })+" matches"
                                                            +" - Team Bonus: "+PairWinrates.filter(function(d, i) { return i==2 } ).map(function(d, i) { return d.TeamBonus })
                                                            +" - Focus: "+PairWinrates.filter(function(d, i) { return i==2 } ).map(function(d, i) { return d.Focus })
                                                            +"<br><br><br><b>Least likely pair to lose</b>"
                                                            +"<br><b>"+PairWinrates.filter(function(d, i) { if(i==34) { return d } }).map(function(d, i) { return d.civpair })
                                                            +"</b> - Winrate: "+PairWinrates.filter(function(d, i) { if(i==34) { return d } }).map(function(d, i) { return (d.winrate*100).toFixed(1); })+"%"
                                                            +" on "+PairWinrates.filter(function(d, i) { if(i==34) { return d } }).map(function(d, i) { return d.matches })+" matches"
                                                            +" - Team Bonus: "+PairWinrates.filter(function(d, i) { return i==34 } ).map(function(d, i) { return d.TeamBonus })
                                                            +" - Focus: "+PairWinrates.filter(function(d, i) { return i==34 } ).map(function(d, i) { return d.Focus })
                                                            +"<br><b>"+PairWinrates.filter(function(d, i) { if(i==33) { return d } }).map(function(d, i) { return d.civpair })
                                                            +"</b> - Winrate: "+PairWinrates.filter(function(d, i) { if(i==33) { return d } }).map(function(d, i) { return (d.winrate*100).toFixed(1); })+"%"
                                                            +" on "+PairWinrates.filter(function(d, i) { if(i==33) { return d } }).map(function(d, i) { return d.matches })+" matches"
                                                            +" - Team Bonus: "+PairWinrates.filter(function(d, i) { return i==33 } ).map(function(d, i) { return d.TeamBonus })
                                                            +" - Focus: "+PairWinrates.filter(function(d, i) { return i==33 } ).map(function(d, i) { return d.Focus })
                                                            +"<br><b>"+PairWinrates.filter(function(d, i) { if(i==32) { return d } }).map(function(d, i) { return d.civpair })
                                                            +"</b> - Winrate: "+PairWinrates.filter(function(d, i) { if(i==32) { return d } }).map(function(d, i) { return (d.winrate*100).toFixed(1); })+"%"
                                                            +" on "+PairWinrates.filter(function(d, i) { if(i==32) { return d } }).map(function(d, i) { return d.matches })+" matches"
                                                            +" - Team Bonus: "+PairWinrates.filter(function(d, i) { return i==32 } ).map(function(d, i) { return d.TeamBonus })
                                                            +" - Focus: "+PairWinrates.filter(function(d, i) { return i==32 } ).map(function(d, i) { return d.Focus })
                                                          );


var iconsel = svg.selectAll(".icon")
              .data(civlist)
              .enter()
              .append("g")
                .attr("class", "icon");

iconsel.append("image")
       .attr("href", function(d, i) {return "https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/Icons/CivIcon-"+civlist[i]+".png"})
       .attr("height", "50px")
       .attr("width", "50px");

iconsel.append("text")
       .attr("transform","translate(22,-5)")
       .text(function(d, i) {return civlist[i]})
       .style("font-size","15px");

iconsel.append("rect")
        .attr("transform","translate(-28,-20)")
        .attr("class", "imgborder")
        .attr("id", function(d, i) {return civlist[i]})
        .attr("width", 100)
        .attr("height", 80)
        .on("mouseup", iconclicked);

iconsel.attr("transform", function(d, i) {
  return "translate(" + (1080+((i%8)*100)) + "," + (50+(((Math.floor(i/8))%8)*80)) + ")";
});

iconsel.select("#"+civselection)
        .style("stroke", "black");

console.log(civdetails.filter(function(d) { return d.Civ==civselection } ));
civtextdivteam.style("left","1380px")
.style("top", "490px")
.style("text-align", "left")
.style("width", "500px")
.style("font-size", "16px").html("<b>Focus: </b>"+civdetails.filter(function(d) { return d.Civ==civselection } ).map(function(d) { return d.Focus })
                                +"<br><b>Team Bonus: </b>"+civdetails.filter(function(d) { return d.Civ==civselection } ).map(function(d) { return d.TB })
                                );




svg.append("rect")
.attr("x",10)
.attr("y",1)
.attr("width", 990)
.attr("height",798)
.style("fill", "none")
.style("stroke-width", 1.5);

svg.append("rect")
.attr("x",1000)
.attr("y",1)
.attr("width", 909)
.attr("height",450)
.style("fill", "none")
.style("stroke-width", 1.5);


svg.append("rect")
.attr("x",1000)
.attr("y",451)
.attr("width", 909)
.attr("height",348)
.style("fill", "none")
.style("stroke-width", 1.5);

function iconclicked(){

    civselection = d3.event.srcElement.id;
    Press3();
};


if(story == 1){

counter = 0;
  svg.append("rect")
  .attr("x",10)
  .attr("y",1)
  .attr("width", 1899)
  .attr("height",798)
  .style("fill", "white")
  .style("opacity", 0)
  .style("stroke-width", 1.5);

var storybox = svg.append("g")
.attr("transform", "translate(800,20)");

  storybox.append("rect")
  .attr("rx", 20)
  .attr("ry", 20)
  .attr("width", 400)
  .attr("height",200)
  .style("fill", "lightgray")
  .style("opacity", 0.8)
  .style("stroke-width", 1.5);


  storybox.selectAll("text")
  .data(storytextarray)
  .enter()
    .append("text")
    .attr("class", "storytext");

    updatestorytext();


  var storyboxbtn = svg.append("g")
  .attr("transform", "translate(950,170)");

  storyboxbtn.append("rect")
  .attr("rx", 10)
  .attr("ry", 10)
  .attr("width", 100)
  .attr("height",40)
  .style("fill", "white")
  .style("opacity", 0.8)
  .style("stroke-width", 1);

  storyboxbtn.append("text")
  .text("Continue")
  .style("font-size", "16px")
  .style("pointer-events", "none")
  .attr("x",8)
  .attr("y",25);

  storyboxbtn.on("mouseup", storyshow);

var highlightrect = svg.append("g");


     highlightrect.append("rect")
       .attr("x", 1030)
       .attr("y", 460)
       .attr("width", 860)
       .attr("height",150)
       .style("fill", "yellow")
       .style("opacity", 0)
       .transition()
       .duration(2000)
       .style("opacity", 0.5);


}; //Story mode

function updatestorytext(){

  storybox.selectAll("text")
             .style("opacity", 0);

  storybox.selectAll("text")
  .data(storytextarray)
    .text(function(d){return d})
    .attr("x", "200")
    .attr("y", function(d, i) {return 30+(i*25)} )
    .transition()
    .duration(1000)
    .style("opacity", 1);

if(counter == 1){
storyboxbtn.select("text")
    .text("Go Back");
}

}


function storyshow(){

if(counter == 0){
  counter = 1;
  storytextarray = ["The chart on the left shows", "each civilization as a node.", "The closer to your selection", "the better the winrate", "How does your favorite do?"];
  highlightrect.remove()
  updatestorytext();
} else {
  story = 0;
  var slidebtns = document.getElementsByClassName("button");
  for(i=0; i<document.getElementsByClassName("button").length; i++){

      slidebtns[i].className =  slidebtns[i].className.replace(" btnstory", "");
  }
Press1();
};

};

};

</script>
</body>
</html>
