<!DOCTYPE html>
<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style>
h1 {text-align: center;}
rect {fill: lightblue; stroke: black;}
path.fade{ display: none;}
.link line {stroke: black;}
.node circle {stroke: black; fill: White;}
.node text {text-anchor: middle; font-size: 10px}

.btn-group .button {
  background-color: white;
  border-radius: 4px;
  color: black;
  padding: 2px 5px;
  text-align: center;
  font-size: 16px;
  float: left;
}

.btn-group .button:hover {
  background-color: grey;
}

.slides {
  border: 1px solid #555555;
}

.navigation {
  border: 1px solid #555555;
}



#civtextdiv {
  position: absolute;
  opacity: 1;
  text-align: left;
   word-wrap: break-word;
   width: 800px;
}

</style>
<body onload='init()'>

<h1>Age of Empires 2: Definitive Edition - Winrates by Civilization in Team Games</h1>

<div id="btngroup" class="btn-group">
  <button id="Prev" class="button navigation"><</button>
  <button id="S1" class="button slides" onclick="init()">1</button>
  <button id="S2" class="button slides" onclick="Press2()">2</button>
  <button id="S3" class="button slides" onclick="Press3()">3</button>
  <button id="Next" class="button navigation">></button>
</div>

<p><br></p>
<div id="civtextdiv"></div>

<script>

var civtextdiv = d3.select("#civtextdiv");

function Press2() {
  S3.style.opacity = 1;
  S3.style.cursor = "default";
  d3.selectAll("svg").remove();
  civtextdiv.html("");
  slide2();
}


function Press3() {
  d3.selectAll("svg").remove();
  civtextdiv.html("");
  slide3();
}

function rotate(angle){
    if(angle > Math.PI) {
        return "rotate(180)"; }
    else { return ""; }
    };


async function init() {
  const winrateciv = await d3.csv('https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/winrate_civ.csv');

  var color = d3.scaleOrdinal(d3.schemeTableau10);

  civlist = winrateciv.map(function(d) {return d.civ});
  winrates = winrateciv.map(function(d) {return d.winrate});


  function updatepie(d, i){

//console.log(value);
       svg.selectAll("image").remove();

       d3.select(this).style("stroke-width", 3);

       groupspie.selectAll("path")
         .data(pie([d3.event.srcElement.__data__.winrate, 1-d3.event.srcElement.__data__.winrate]))
           .attr("d", arc)
           .attr("fill", function(d,i) {if(i==0) { return color(4)} else {return color(2)};})
           .attr("stroke", "black")
           .attr("stroke-width", 0.5);


       groupspie.append("image")
           .attr("href", "https://vignette.wikia.nocookie.net/ageofempires/images/9/9a/CivIcon-Japanese.png/")
           .attr("x", -50)
           .attr("y", -50)
           .attr("height", "100px")
           .attr("width", "100px");


           groupspie.selectAll("text").remove();

           groupspie.append("text")
               .each(function(d){ return d.angle = (d.startAngle + d.endAngle) /2; })
               .attr("class", "text")
               .style("pointer-events","none")
               .attr("text-anchor", function(d) { if(d.angle > Math.PI) { return "end"; } else { return "start"; }})
               .attr("transform", function(d,i){
                   return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
                          "translate(" + (outrad + 10) + ")" +
                           (rotate(d.angle));

               })
               .text(function(d,i) {if(i==0) { return (d3.event.srcElement.__data__.winrate*100).toFixed(1)+"%"} else {return ((1-d3.event.srcElement.__data__.winrate)*100).toFixed(1)+"%"};})
               .style("font-family","sans-serif")
               .style("font-size","15px")
               .style("font-weight","bold");

var focus = "Infantry";
var CivBonus = ("<ul><li>Infantry are 20%/25%/30%/35% cheaper in the Dark/Feudal/Castle/Imperial Age.</li><li>Infantry have +1/+2/+3 attack bonus against standard buildings in the Feudal/Castle/Imperial Age.</li><li>Villagers have +5 attack against Wild Boars and carry +15 food from hunting.</li><li>Loom is free.</li><li>+10 population cap in the Imperial Age.</li></ul>");
var TeamBonus = "Barracks work 20% faster."

civtextdiv.style("left","850px").style("top", "670px").html("<b>Focus: </b>"+focus+"<br><br>"+"<b>Civilization Bonuses: </b>"+CivBonus+"<br>"+"<b>Team Bonus: </b>"+TeamBonus);

  }


function mouseoutbar(d, i){

        d3.select(this).style("stroke-width", 1);
}



  var screenw = (screen.width-10);
  var width = 1500;
  var heightsvg = 650;
  var smargin = (screenw-width)/2;
  var tmargin = 50;
  var widthpie = 250;
  var height = heightsvg - widthpie;

  if(d3.selectAll("svg").size()!=0){ d3.selectAll("svg").remove() };

  var svg = d3.select("body").append("svg")
      .attr("width",  width+(smargin*2))
      .attr("height", heightsvg+(tmargin*2));



  x = d3.scaleBand().domain(civlist).range([0,width]).padding(0.2);;
  y = d3.scaleLinear().domain([0,1]).range([height,0]);


  svg.append("g")
      .attr("transform", "translate("+smargin+","+tmargin+")")
    .selectAll('rect')
    .data(winrateciv)
    .enter()
    .append('rect')
      .attr('x',function(d) {return x(d.civ);})
      .attr('y',function(d) {return y(0);})
      .attr('width',x.bandwidth())
      .attr('height',0)
      .style("fill", function(d, i) {return color(i);})
      .style("stroke-width", 1);

  svg.append("g")
      .attr("transform", "translate("+smargin+","+tmargin+")")
      .call(d3.axisLeft(y).tickFormat(d3.format("~%")));

  svg.append("g")
      .attr("transform", "translate("+smargin+","+(height+tmargin)+")")
      .call(d3.axisBottom(x))
      .selectAll("text")
      .attr("y", 0)
      .attr("x", 9)
      .attr("dy", ".35em")
      .attr("transform", "rotate(90)")
      .style("text-anchor", "start");


  svg.selectAll("rect")
    .transition()
    .duration(1000)
    .attr("y", function(d) {return y(d.winrate);})
    .attr("height", function(d,i) {return y(1-Number(d.winrate));})



//function(d,i) {tooltip.style("opacity", 1).style("left", (d3.event.pageX)+"px").style("top", (d3.event.pageY)+"px").html(d.winrate);}

//Pie chart


var center = 150;
var inrad = 50;
var outrad = 100;
var colorinit = ['grey','darkgrey'];
//var color = ['green','red'];
var pie = d3.pie().sort(null);
var arc = d3.arc().innerRadius(inrad).outerRadius(outrad);



var groupspie = svg.append("g")
    .attr("transform", "translate(550,650)")
    .selectAll("g")
    .data(pie([0.5, 0.5]))
    .enter()
    .append("g");


      groupspie.selectAll("path")
        .data(pie([0.5, 0.5]))
        .enter()
        .append("path")
          .attr("d", arc)
          .attr("fill", function(d,i) {return colorinit[i];});

 groupspie.append("text")
    .each(function(d){ return d.angle = (d.startAngle + d.endAngle) /2; })
    .attr("class", "text")
    .style("pointer-events","none")
    .attr("text-anchor", function(d) { if(d.angle > Math.PI) { return "end"; } else { return "start"; }})
    .attr("transform", function(d,i){
        return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
               "translate(" + (outrad + 10) + ")" +
                (rotate(d.angle));

    })
    .text(function(d,i) {if(i==0) { return "%"} else {return "%"};})
    .style("font-family","sans-serif")
    .style("font-size","15px");


svg.selectAll("rect")
   .on("mouseover", updatepie);


svg.selectAll("rect")
    .on("mouseout", mouseoutbar);


groupspie.append("image")
    .attr("href", "https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/CivIcon-q.png")
    .attr("x", -50)
    .attr("y", -50)
    .attr("height", "100px")
    .attr("width", "100px");


    civtextdiv.style("left","850px").style("top", "670px").html("<b>Focus: </b>"+"<br><br>"+"<b>Civilization Bonuses: </b>"+"<br>"+"<b>Team Bonus: </b>");

};


async function slide2(){
            console.log("Slide2");

            const pairsMatrix = await d3.csv("https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/PairsMatrixComplete.csv");


        var margin      = {top: 10, right: 10, bottom: 10, left: 10};
        var width       = 800 - margin.left - margin.right;
        var height      = 800 - margin.top  - margin.bottom;
        var innerRadius = width * .4;
        var outerRadius = innerRadius * 1.05;

        var svg = d3.select("body").append("svg")
            .attr("width",  width  + margin.left + margin.right)
            .attr("height", height + margin.top  + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .append("g")
            .attr("class", "chordgraph")
            .attr("transform", "translate(" + width/2 + "," + height/2 + ")");


        var firstColumn = "Civ1";

        //store column names
        var fc = [],
            mat_size = pairsMatrix.length,
            matrix  = [];

        for(var i=0; i < mat_size; i++){
            matrix.push(new Array(mat_size+1).join('0').split('').map(parseFloat));
        }

        for(var i=0; i < mat_size; i++){

            var j = 0;

            for(var pairm in pairsMatrix[i]){

                if(pairm != firstColumn){
                    fc.push(pairm);
                    matrix[i][j] = +pairsMatrix[i][pairm];
                    matrix[j][i] = +pairsMatrix[i][pairm];
                    j++;
                }
            }
        }

        var fo = fc.slice(0,mat_size);


        //set color scale. More color options: https://github.com/d3/d3-scale-chromatic
        var color = d3.scaleOrdinal(d3.schemeTableau10)

        //d3 chord generator
        var chord = d3.chord()
            .padAngle(0.01)
            .sortSubgroups(d3.descending);

        //apply the matrix
        var chords = chord(matrix);

        //each ribbon generator
        var ribbon = d3.ribbon()
            .radius(innerRadius);

        //outer rim arc
        var arc = d3.arc()
            .innerRadius(innerRadius)
            .outerRadius(innerRadius + 20);

        //add each of the groupings for outer rim arcs
        var group = svg.append("g")
            .selectAll("g")
            .data(chords.groups)
            .enter()
            .append("g");

        //add each outer rim arc path
        group.append("path")
            .attr("fill", function(d){ return color(d.index); })
            .attr("d", arc)
            .style("cursor", "pointer")
            .on("mouseover", function(d, i){
                ribbons.classed("fade", function(d){
                    return d.source.index != i && d.target.index != i;
                });
            });
        console.log(chords);
        //add each ribbon
        var ribbons = svg.append("g")
          .attr("fill-opacity", .5)
          .selectAll("path")
          .data(chords)
          .enter()
          .append("path")
          .attr("d", ribbon)
          .attr("fill", function(d){ return color(d.source.index); })
          .attr("stroke", "black")
          .style("stroke","Black")
          .style("stroke-width",".25px");


        //add the text labels
        group.append("text")
          .each(function(d){ return d.angle = (d.startAngle + d.endAngle) /2; })
          .attr("class", "text")
          .style("pointer-events","none")
          .attr("text-anchor", function(d) { if(d.angle > Math.PI) { return "end"; } else { return "start"; }})
          .attr("transform", function(d,i){
              return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
                     "translate(" + (outerRadius + 10) + ")" +
                     (rotate(d.angle));

          })
          .text(function(d,i){
              //set the text content
              return fc[i];
          })
          .style("font-family","sans-serif")
          .style("font-size","15px");



            window.addEventListener('mouseup', (e) => {

              if(e.target.tagName == "svg");{
                ribbons.classed("fade", false)
              };
            })
        };


async function slide3(){

console.log("Slide3");
const winrateciv = await d3.csv('https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/winrate_civ.csv');
 const data = await d3.csv('https://raw.githubusercontent.com/Diegoma89/diegoma89.github.io/master/data_matches_formatted_reduced.csv');
 const civ1WD = data.filter(function(d) {return d.teamcivs.includes("Slavs")})
  console.log(civ1WD);

var  civlist = winrateciv.map(function(d) {return d.civ});
var  winrates = winrateciv.map(function(d) {return d.winrate});


  var i;
  var PairWins = [];
  var PairMatches = [];
  var PairWinrates = [];
  var CurrCiv = "Slavs";
  var nodes = [{"value": "Selection"}];
  var links = [];

  for (i = 0; i < civlist.length; i++) {
    if (civlist[i] == CurrCiv) {
      var civ2WD = civ1WD.filter(function(d) { if(d.teamcivs.indexOf(civlist[i]) != d.teamcivs.lastIndexOf(civlist[i])) {return d.teamcivs} });
      nodes.push({"value": civlist[i]});
      links.push({"source":  "Selection", "target":  civlist[i], "winrate": ((d3.sum(civ2WD, function(d) { return d.won }))/civ2WD.length)});
    }
    else {
      var civ2WD = civ1WD.filter(function(d) {return d.teamcivs.includes(civlist[i])});
      nodes.push({"value": civlist[i]});
      links.push({"source":  "Selection", "target":  civlist[i], "winrate": ((d3.sum(civ2WD, function(d) { return d.won }))/civ2WD.length)});
    };

    var PairWin = d3.sum(civ2WD, function(d) { return d.won });
    PairWins.push(PairWin);
    PairMatches.push(civ2WD.length);
    PairWinrates.push(PairWin/civ2WD.length)
  };

console.log(PairWinrates);
var width = 1000;
var height = 700;
var radius = 30;
var margin = 5;
var svg = d3.select("body").append("svg")
    .attr("width",  width)
    .attr("height", height);

var svg = d3.select("svg"),
width = +svg.attr("width"),
height = +svg.attr("height");

var simulation = d3.forceSimulation()
.force("link", d3.forceLink().distance(function(d) { /*return 400-(d.winrate*400)*/if(d.winrate==0) { return 400 } else {return (Math.abs(Math.log(d.winrate)))*250 };})
    .id(function(d) { return d.value;}))
.force("charge", d3.forceManyBody())
.force("center", d3.forceCenter(width / 2, height / 2));



simulation.nodes(nodes);


simulation.force("link").links(links);


var linksel = svg.append("g")
.attr("class", "link")
.selectAll("line").data(links).enter().append("line")

var nodesel = svg.selectAll(".node")
.data(nodes)
.enter().append("g")
.attr("class", "node")
.call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended));

nodesel.append("circle")
.attr("r",radius);

nodesel.append("text")
.attr("transform","translate(0,4)")
.text(function (d) { return d.value; });

// replace "tick" with "end" for static layout
simulation.on("tick", ticked);

function ticked() {


nodesel.attr("cx", function(d) { return d.x = Math.max(radius + margin, Math.min(width - radius - margin, d.x)); })
        .attr("cy", function(d) { return d.y = Math.max(radius + margin, Math.min(height - radius - margin, d.y)); });

        linksel.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

            nodesel.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
}

function dragstarted(d) {
if (!d3.event.active) simulation.alphaTarget(0.3).restart();
d.fx = d.x;
d.fy = d.y;
}
function dragged(d) {
d.fx = d3.event.x;
d.fy = d3.event.y;
}
function dragended(d) {
if (!d3.event.active) simulation.alphaTarget(0);
d.fx = null;
d.fy = null;
}
};


/* start histo combined
 const civ1WD = data.filter(function(d) {return d.teamcivs.includes("Britons")})
  console.log(civ1WD);

  var i;
  var PairWins = [];
  var PairMatches = [];
  var PairWinrates = [];
  var CurrCiv = "Britons";

  for (i = 0; i < civlist.length; i++) {
    if (civlist[i] == CurrCiv) {
      var civ2WD = civ1WD.filter(function(d) { if(d.teamcivs.indexOf(civlist[i]) != d.teamcivs.lastIndexOf(civlist[i])) {return d.teamcivs} });
    }
    else {
      var civ2WD = civ1WD.filter(function(d) {return d.teamcivs.includes(civlist[i])});
    };

    var PairWin = d3.sum(civ2WD, function(d) { return d.won });
    PairWins.push(PairWin);
    PairMatches.push(civ2WD.length);
    PairWinrates.push(PairWin/civ2WD.length)
  };


  var width = 500
  var height = 500
  var margin = 50

  x = d3.scaleBand().domain(civlist).range([0,width]);
  y = d3.scaleLinear().domain([0,1]).range([height,0]);
  d3.select('svg')
    .append("g")
      .attr("transform", "translate("+margin+","+margin+")")
    .selectAll('rect')
    .data(PairWinrates)
    .enter()
    .append('rect')
      .attr('x',function(d,i) {return x(civlist[i]);})
      .attr('y',function(d) {return y(d);})
      .attr('width',x.bandwidth())
      .attr('height',function(d) {return y(1-Number(d));})

  d3.select('svg')
    .append("g")
      .attr("transform", "translate("+margin+","+margin+")")
      .call(d3.axisLeft(y))

  d3.select('svg')
    .append("g")
      .attr("transform", "translate("+margin+","+(height+margin)+")")
      .call(d3.axisBottom(x))
      .selectAll("text")
      .attr("y", 0)
      .attr("x", 9)
      .attr("dy", ".35em")
      .attr("transform", "rotate(90)")
      .style("text-anchor", "start");

end histo combined */


</script>
</body>
</html>
